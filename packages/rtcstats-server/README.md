This is part of the [monorepo](https://github.com/rtcstats/rtcstats) for rtcstats-js
(clientside monitoring), rtcstats-server (serverside dump collection) and the updated
dump-importer (supporting rtcstats and webrtc-internals formats).

It is part of a bigger offering that includes [rtcstats.com](https://rtcstats.com),
an online service for debugging and troubleshooting WebRTC statistics.

# rtcstats-server
The server listens on a WebSocket and writes the incoming data (the "dump") to a temporary file.
If configured, the dump file is uploaded to storage (S3 or compatible) and metadata is
written to a database (postgres or compatible). See [below](#rtcstats-dump-file-format) for
a formal specification of the dump file format.

Compared to previous iterations of rtcstats-server, feature extraction is currently not supported.

## Building

Running
```
npm test
```
will run linting and unit/e2e tests for rtcstats-server.

## Usage with Docker
See the Dockerfile in the toplevel directory.

# JWT-based authentication
By default, rtcstats-server will accept any websocket connection.

It is preferable to authorize such connections using [JSON Web Token](https://en.wikipedia.org/wiki/JSON_Web_Token).
This also allows secure identification of users, conferences and sessions.

rtcstats-js supports adding JWT tokens to the WebSocket URL as part of the query string, i.e.
```
trace.connect('wss://example.com?rtcstats-token=...
```
When configured with `authorization.jwtSecret`, rtcstats-server will validate the token.
If the token is not valid, the WebSocket connection will be closed with a `policy-violation`
(code 1008) error.
If the token is valid, RTCStats-server will extract the `rtcstats` object and export the
following fields to the database:
* user: a long-lived service-defined identifer for the user
* session: a short-lived service-defined identiÔ¨Åier for the user session.
* conference: a service-defined identifier for a conference or call. This can be used to search and groups dumps with multiple users.

See the [example](/example/) for how such a integration looks like.

# RTCStats dump file format

RTCStats dump files are line-oriented JSON as described in [JSON Lines](https://jsonlines.org/).

This section described the file format in **version 3**. See below for older file formats and upgrading
Breaking changes to the file format require an upgrade plan.

RTCStats dump files may be compressed using standard compression methods such as gzip, bzip or brotli.
* WebRTC domain specific compression such as method compression or stats property compression MUST be supported by importers and MAY be used by clients.
* getStats delta compression MUST be supported by importers and MAY be used by clients.

The first line of every file is `RTCStatsDump` followed by a new line and a JSON object with metadata.
*  At minimum that line must include the "fileFormat" property with an integer value specifying the file format version.

Every line after this is a JSON array with RTCStats events.
* Usually four elements but some methods have additional elements.
* First element is the method name, e.g. `setLocalDescription`
  * This may be compressed using a static table
* Second element is the peerconnection id or `null` if this is not related to a peerconnection.
  * E.g. getUserMedia-related events are not associated with a peerconnection
* Third element is the arguments to the call or the event.
  * The value type and format depend on the method name
  * For most events it is either an array with the arguments to the API call serialized as an array. If the method has only a single argument this will be used as-is
* There may be additional elements
  * E.g. a correlation id to associate a call to setLocalDescription with a call to its corresponding setLocalDescriptionOnSuccess. For events related to RTCRtpTransceiver or RTCRtpSender an object identifier.
* The last element is the timestamp delta in milliseconds at which the event was generated by the client, given as a UNIX timestamp (this means the first delta is relative to the UNIX epoch).
* Personally identifiable information SHOULD be obfuscated
    * Servers SHOULD do obfuscation, clients MAY.
    * E.g. IP addresses on SDP, onicecandidate, addIceCandidate or statistics.
    * Device labels from enumerateDevices or getUserMediaOnSuccess

## Old versions
Versions 1 and 2 were used by the legacy RTCStats server. They are not supported.

# Postgres tables
rtcstats-server currently expects the following table format:
```
CREATE TABLE public.rtcstats(
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    rtcstats_user text,
    rtcstats_conference text,
    rtcstats_session text,
    metadata jsonb,
    blob_url text,
    features_url text,
    session_start timestamp with time zone,
    session_end timestamp with time zone
);
```

Note: a future version will move this definition to database migrations.
